name: Langflow - Build & Push

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      version:
        description: 'Version tag for PROD (optional, defaults to commit SHA)'
        required: false
        type: string

env:
  NODE_VERSION: "18"
  REGISTRY: ghcr.io

jobs:
  # Stage 1: Build frontend separately to reduce Docker build disk usage
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: src/frontend
        run: npm ci --no-audit --no-fund

      - name: Build frontend
        working-directory: src/frontend
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: src/frontend/build
          retention-days: 1
          compression-level: 9

  # Stage 2a: DEV build - triggers on push to main or manual trigger with dev environment
  build-dev:
    name: Build DEV image
    runs-on: ubuntu-latest
    needs: build-frontend
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: src/frontend/build

      - name: Allow frontend build in Docker context
        run: |
          sed -i.bak '/^src\/frontend\/build$/d' .dockerignore

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          docker image prune -af || true
          docker builder prune -af || true
          docker system prune -af --volumes || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Owner lowercase
        id: owner
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ github.repository_owner }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push DEV image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/build_and_push.Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/langflow:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/langflow:dev
          build-args: |
            FRONTEND_PREBUILT=1
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Summary
        run: |
          echo "## ðŸš€ DEV image pushed to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| langflow | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| langflow | \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ ArgoCD Image Updater will automatically deploy to DEV." >> $GITHUB_STEP_SUMMARY

  # Stage 2b: PROD build - triggers on release publish or manual trigger with prod environment
  build-prod:
    name: Build PROD image
    runs-on: ubuntu-latest
    needs: build-frontend
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: src/frontend/build

      - name: Allow frontend build in Docker context
        run: |
          sed -i.bak '/^src\/frontend\/build$/d' .dockerignore

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          docker image prune -af || true
          docker builder prune -af || true
          docker system prune -af --volumes || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Owner lowercase
        id: owner
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ github.repository_owner }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            else
              echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push PROD image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/build_and_push.Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/langflow:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/langflow:${{ steps.version.outputs.version }}-prod
            ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/langflow:prod
            ${{ env.REGISTRY }}/${{ steps.owner.outputs.lowercase }}/langflow:latest
          build-args: |
            FRONTEND_PREBUILT=1
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Summary
        run: |
          echo "## ðŸš€ PROD image pushed to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| langflow | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ ArgoCD Image Updater will detect and prepare deployment to PROD." >> $GITHUB_STEP_SUMMARY
